{% extends "base.html" %}
{% block content %}

<div class="flex flex-col gap-4">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">Payroll</h1>
    <span class="badge">MVP</span>
  </div>

  {% if request.query_params.get("error") == "employee_not_found" %}
    <div class="card p-3">الموظف غير موجود.</div>
  {% endif %}
  {% if request.query_params.get("error") == "bad_date" %}
    <div class="card p-3">صيغة التاريخ غلط.</div>
  {% endif %}
  {% if request.query_params.get("error") == "range" %}
    <div class="card p-3">period_end لازم يكون بعد period_start.</div>
  {% endif %}
  {% if request.query_params.get("error") == "forbidden" %}
    <div class="card p-3">مش معاك صلاحية.</div>
  {% endif %}
  {% if request.query_params.get("success") == "1" %}
    <div class="card p-3">✅ Payroll run اتعمل بنجاح.</div>
  {% endif %}

  {% if not employees %}
    <div class="card p-4">مفيش موظفين لسه.</div>
  {% else %}

    <div class="card p-4 flex flex-col gap-3">
      <form method="get" action="/payroll" class="flex items-center gap-2 flex-wrap">
        <div class="font-semibold">Employee:</div>
        <select name="employee_id">
          {% for e in employees %}
            <option value="{{ e.id }}" {% if employee and employee.id == e.id %}selected{% endif %}>
              {{ e.full_name }} (ID: {{ e.id }})
            </option>
          {% endfor %}
        </select>
        <button class="btn" type="submit">Go</button>
      </form>

      {% if employee %}
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-3">
            <div class="font-semibold mb-2">Base Salary</div>
            <form method="post" action="/payroll/employee/{{ employee.id }}/salary" class="flex gap-2 items-center">
              <input name="base_salary" type="number" step="0.01" value="{{ employee.base_salary }}" />
              <button class="btn" type="submit">Save</button>
            </form>
          </div>

          <div class="card p-3">
            <div class="font-semibold mb-2">Run Payroll</div>
            {% if can_run %}
              <form method="post" action="/payroll/run" class="flex flex-col gap-2">
                <input name="period_start" type="date" required />
                <input name="period_end" type="date" required />
                <input name="notes" type="text" placeholder="notes (optional)" />
                <button class="btn" type="submit">Run</button>
              </form>
            {% else %}
              <div class="opacity-80 text-sm">محتاج permission: payroll.run</div>
            {% endif %}
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold">Allowances</div>
            </div>

            <form method="post" action="/payroll/employee/{{ employee.id }}/allowances/new" class="flex gap-2 flex-wrap mb-3">
              <input name="name" placeholder="name" required />
              <input name="amount" type="number" step="0.01" placeholder="amount" required />
              <button class="btn" type="submit">Add</button>
            </form>

            <table class="table w-full">
              <thead>
                <tr>
                  <th>Name</th><th>Amount</th><th>Active</th>
                </tr>
              </thead>
              <tbody>
                {% for a in allowances %}
                  <tr>
                    <td>{{ a.name }}</td>
                    <td>{{ a.amount }}</td>
                    <td>{{ "Yes" if a.active else "No" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold">Deductions</div>
            </div>

            <form method="post" action="/payroll/employee/{{ employee.id }}/deductions/new" class="flex gap-2 flex-wrap mb-3">
              <input name="name" placeholder="name" required />
              <input name="amount" type="number" step="0.01" placeholder="amount" required />
              <button class="btn" type="submit">Add</button>
            </form>

            <table class="table w-full">
              <thead>
                <tr>
                  <th>Name</th><th>Amount</th><th>Active</th>
                </tr>
              </thead>
              <tbody>
                {% for d in deductions %}
                  <tr>
                    <td>{{ d.name }}</td>
                    <td>{{ d.amount }}</td>
                    <td>{{ "Yes" if d.active else "No" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card p-4">
          <div class="font-semibold mb-2">Latest Payroll Runs (10)</div>
          <table class="table w-full">
            <thead>
              <tr>
                <th>ID</th>
                <th>Period</th>
                <th>Status</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              {% for r in runs %}
                <tr>
                  <td>{{ r.id }}</td>
                  <td>{{ r.period_start }} → {{ r.period_end }}</td>
                  <td>{{ r.status }}</td>
                  <td>{{ r.created_at }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {% endif %}
    </div>

  {% endif %}
</div>

{% endblock %}
