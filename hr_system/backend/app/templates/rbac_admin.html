{% extends "base.html" %}

{% block content %}
<div class="flex flex-col gap-4">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">RBAC admin</h1>
    <span class="badge">MVP</span>
  </div>


  {% if request.query_params.get('error') %}
    <div class="card" style="padding:12px; margin: 12px 0;">
      <b>Error:</b> {{ request.query_params.get('error') }}
    </div>
  {% endif %}

  {% if request.query_params.get('success') %}
    <div class="card" style="padding:12px; margin: 12px 0;">
      <b>Success</b>
    </div>
  {% endif %}

  <div class="card" style="padding:16px;">
    <h3 style="margin:0 0 10px 0;">Users & Roles</h3>

    <table style="width:100%; border-collapse: collapse;">
      <thead>
        <tr style="text-align:left; opacity:.85;">
          <th style="padding:8px;">User</th>
          <th style="padding:8px;">Current Roles</th>
          <th style="padding:8px;">Assign Roles</th>
          <th style="padding:8px;">Role Permissions (read)</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
          <tr style="border-top: 1px solid rgba(255,255,255,.08); vertical-align: top;">
            <td style="padding:8px;">
              <div><b>#{{ u.id }}</b> {{ u.username }}</div>
              <div style="opacity:.75; font-size:12px;">{{ "Admin" if u.is_admin else "User" }}</div>
            </td>

            <td style="padding:8px;">
              {% set rids = user_roles_map.get(u.id, []) %}
              {% if not rids %}
                <span style="opacity:.7;">-</span>
              {% else %}
                {% for rid in rids %}
                  {% for r in roles %}
                    {% if r.id == rid %}
                      <div style="display:inline-block; margin:2px 4px 2px 0; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06);">
                        {{ r.name }}
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
            </td>

            <td style="padding:8px; min-width: 280px;">
              <form method="post" action="/rbac/assign" style="display:grid; gap:8px;">
                <input type="hidden" name="user_id" value="{{ u.id }}" />

                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  {% for r in roles %}
                    {% set checked = (r.id in user_roles_map.get(u.id, [])) %}
                    <label style="display:flex; gap:6px; align-items:center; opacity:.92;">
                      <input
                        class="rbac-role"
                        type="checkbox"
                        data-user="{{ u.id }}"
                        data-role="{{ r.id }}"
                        {% if checked %}checked{% endif %}
                      />
                      {{ r.name }}
                    </label>
                  {% endfor %}
                </div>

                <!-- hidden field updated by JS -->
                <input
                  type="hidden"
                  id="role_ids_{{ u.id }}"
                  name="role_ids"
                  value="{{ user_roles_map.get(u.id, []) | join(',') }}"
                />

                <div>
                  <button class="btn" type="submit">Save</button>
                </div>
              </form>
            </td>

            <td style="padding:8px; min-width: 260px;">
              {% set rids = user_roles_map.get(u.id, []) %}
              {% if not rids %}
                <span style="opacity:.7;">-</span>
              {% else %}
                {% for rid in rids %}
                  {% for r in roles %}
                    {% if r.id == rid %}
                      <div style="margin-bottom:8px;">
                        <div style="opacity:.85;"><b>{{ r.name }}</b></div>
                        {% set perms = role_perms.get(rid, []) %}
                        {% if not perms %}
                          <div style="opacity:.65; font-size:12px;">(no permissions)</div>
                        {% else %}
                          <div style="font-size:12px; opacity:.85;">
                            {% for p in perms %}
                              <div>â€¢ {{ p }}</div>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  function updateHidden(userId, roleId, checked) {
    const hidden = document.getElementById("role_ids_" + userId);
    const current = (hidden.value || "")
      .split(",")
      .map(x => x.trim())
      .filter(Boolean);

    const set = new Set(current);
    const rid = String(roleId);

    if (checked) set.add(rid);
    else set.delete(rid);

    hidden.value = Array.from(set).join(",");
  }

  document.addEventListener("change", (e) => {
    const el = e.target;
    if (!el.classList || !el.classList.contains("rbac-role")) return;

    const userId = el.getAttribute("data-user");
    const roleId = el.getAttribute("data-role");
    updateHidden(userId, roleId, el.checked);
  });
</script>
{% endblock %}
